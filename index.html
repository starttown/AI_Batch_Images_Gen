<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>魔搭社区批量文生图工具（Node代理版）</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; background-color: #f9f9f9; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        textarea, input, select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .result { margin-top: 20px; }
        .result img { max-width: 200px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .result img:hover { transform: scale(1.05); }
        .status { margin: 10px 0; padding: 10px; background-color: #eef; border-radius: 4px; }
        .error { color: red; }
        .success { color: green; }
        .debug { font-family: monospace; background-color: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
        .image-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .image-item { text-align: center; position: relative; }
        .image-item img { max-width: 200px; border-radius: 4px; border: 1px solid #ddd; }
        .image-item p { margin: 5px 0; font-size: 14px; color: #666; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { margin: auto; display: block; width: 80%; max-width: 700px; margin-top: 50px; }
        .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        .download-all-btn { margin-top: 20px; background-color: #28a745; }
        .download-all-btn:hover { background-color: #218838; }
        .log-container { margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; border-radius: 4px; }
        .copy-log-btn { margin-top: 10px; background-color: #17a2b8; }
        .copy-log-btn:hover { background-color: #138496; }
    </style>
</head>
<body>
    <div class="container">
        <h1>魔搭社区批量文生图工具（Node代理版）</h1>
        <p>使用魔搭社区（ModelScope）免费API，支持批量生成图片，每日免费额度2000次。</p>
        <hr>
        <h2>1. 设置 API Token</h2>
        <input type="password" id="api_key" placeholder="请输入您的 ModelScope Access Token（可带 ms- 前缀）">
        <p><small>获取Token：<a href="https://modelscope.cn/my/myaccesstoken" target="_blank">https://modelscope.cn/my/myaccesstoken</a></small></p>
        <hr>
        <h2>2. 选择模型</h2>
        <select id="model">
            <option value="black-forest-labs/FLUX.1-Krea-dev">FLUX.1-Krea-dev</option>
        </select>
        <hr>
        <h2>3. 输入提示词（每行一个）</h2>
        <textarea id="prompts" rows="10" placeholder="例如：&#10;一只橘猫在窗台上睡觉&#10;赛博朋克风格的街道夜景"></textarea>
        <hr>
        <h2>4. 高级参数（可选）</h2>
        <p>尺寸（宽x高）：<input type="text" id="size" placeholder="1024x1024" value="1024x1024"></p>
        <!-- 修复：移除max限制和提示文字 -->
        <p>批量生成个数：<input type="number" id="batch_count" min="1" value="1" style="width: 100px; display: inline-block;">（每个提示词生成的图片数量）</p>
        <hr>
        <button onclick="startBatchGenerate()">开始批量生成</button>
        <div id="status" class="status"></div>
        <div id="result" class="result">
            <h2>生成结果</h2>
            <div id="image-container" class="image-container"></div>
            <button id="downloadAllBtn" class="download-all-btn" style="display: none;" onclick="downloadAllImages()">下载所有图片</button>
            
            <h2 style="margin-top: 30px;">日志记录</h2>
            <div id="logContainer" class="log-container" style="display: none;">
                <pre id="logContent"></pre>
            </div>
            <button id="copyLogBtn" class="copy-log-btn" style="display: none;" onclick="copyLog()">复制日志到剪贴板</button>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
    // 存储所有生成的图片信息
    let allGeneratedImages = [];
    // 存储日志信息
    let logData = [];

    async function startBatchGenerate() {
        const apiKey = document.getElementById('api_key').value.trim();
        const model = document.getElementById('model').value;
        const promptsText = document.getElementById('prompts').value.trim();
        let size = document.getElementById('size').value.trim();
        const batchCount = parseInt(document.getElementById('batch_count').value) || 1;
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('image-container');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const logContainer = document.getElementById('logContainer');
        const logContent = document.getElementById('logContent');
        const copyLogBtn = document.getElementById('copyLogBtn');

        if (!apiKey || !promptsText) {
            statusEl.innerHTML = '<span class="error">请填写API Token和提示词！</span>';
            return;
        }

        // 重置状态
        allGeneratedImages = [];
        logData = [];
        resultEl.innerHTML = '';
        downloadAllBtn.style.display = 'none';
        logContainer.style.display = 'none';
        copyLogBtn.style.display = 'none';

        // 强制将尺寸格式中的 '*' 替换为 'x'
        size = size.replace(/\*/g, 'x');

        const prompts = promptsText.split('\n').map(p => p.trim()).filter(p => p);
        statusEl.innerHTML = `开始批量生成，共${prompts.length}个提示词，每个生成${batchCount}张图片，请耐心等待...`;

        const base_url = 'http://localhost:3000/proxy';
        const headers = {
            'Authorization': 'Bearer ' + (apiKey.startsWith('ms-') ? apiKey : 'ms-' + apiKey),
            'Content-Type': 'application/json',
            'X-ModelScope-Async-Mode': 'true'
        };

        let totalTasks = prompts.length * batchCount;
        let completedTasks = 0;

        // 严格串行处理：每个任务完全完成后再处理下一个
        for (const prompt of prompts) {
            for (let i = 0; i < batchCount; i++) {
                try {
                    const batchPrompt = `${prompt} (第${i+1}/${batchCount}张)`;
                    const payload = { model, prompt, size };
                    
                    statusEl.innerHTML = `正在提交任务 [${completedTasks+1}/${totalTasks}]：${batchPrompt}`;
                    
                    const resp = await fetch(base_url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: 'https://api-inference.modelscope.cn/v1/images/generations',
                            headers,
                            body: payload
                        })
                    });
                    
                    const data = await resp.json();
                    
                    // 记录日志
                    logData.push(`--- 新任务 [${completedTasks+1}/${totalTasks}] ---`);
                    logData.push('请求体：' + JSON.stringify(payload, null, 2));
                    logData.push('响应：' + JSON.stringify(data, null, 2));
                    logData.push('');

                    if (!resp.ok || data.task_id === undefined) {
                        statusEl.innerHTML = '<span class="error">请求失败：' + JSON.stringify(data) + '</span>';
                        completedTasks++;
                        continue;
                    }
                    
                    const taskId = data.task_id;
                    statusEl.innerHTML = `任务提交成功 [${completedTasks+1}/${totalTasks}]，ID：${taskId}，等待生成...`;
                    
                    // 等待当前任务完全完成后再继续下一个
                    const taskSuccess = await pollForResult(taskId, batchPrompt, headers, resultEl, statusEl, i+1);
                    
                    completedTasks++;
                    
                    // 每个任务完成后增加延迟，避免频率限制
                    if (taskSuccess && completedTasks < totalTasks) {
                        statusEl.innerHTML = '等待3秒后提交下一个任务...';
                        await new Promise(r => setTimeout(r, 3000));
                    }
                } catch (e) {
                    statusEl.innerHTML = '<span class="error">异常：' + e.message + '</span>';
                    logData.push('异常：' + e.message);
                    logData.push('');
                    completedTasks++;
                }
            }
        }
        
        // 所有任务完成后，显示下载按钮
        if (allGeneratedImages.length > 0) {
            downloadAllBtn.style.display = 'block';
        }
        
        // 保存日志到localStorage并显示
        if (logData.length > 0) {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const logKey = `modelscope_log_${timestamp}`;
            const logContentStr = logData.join('\n');
            
            // 保存到localStorage
            localStorage.setItem(logKey, logContentStr);
            
            // 保存日志键到历史记录
            let logHistory = JSON.parse(localStorage.getItem('modelscope_log_history') || '[]');
            logHistory.unshift(logKey);
            // 只保留最近10条日志
            if (logHistory.length > 10) {
                logHistory = logHistory.slice(0, 10);
            }
            localStorage.setItem('modelscope_log_history', JSON.stringify(logHistory));
            
            // 显示日志
            logContent.textContent = logContentStr;
            logContainer.style.display = 'block';
            copyLogBtn.style.display = 'block';
            
            console.log('日志已保存到localStorage，键名：', logKey);
        }
        
        statusEl.innerHTML = '<span class="success">批量生成完成！</span>';
    }

    async function pollForResult(taskId, prompt, headers, resultEl, statusEl, batchIndex) {
        const pollUrl = 'http://localhost:3000/proxy';
        
        // 增加轮询超时时间：从60次增加到120次（总时长10分钟）
        for (let i = 0; i < 120; i++) {
            await new Promise(r => setTimeout(r, 5000));
            
            const resp = await fetch(`${pollUrl}?url=${encodeURIComponent(`https://api-inference.modelscope.cn/v1/tasks/${taskId}`)}&authorization=${encodeURIComponent(headers.Authorization)}`, {
                method: 'GET'
            });
            
            const data = await resp.json();
            
            // 只在状态栏显示当前轮询进度
            statusEl.innerHTML = `正在处理任务 [${batchIndex}]，轮询 ${i+1}/120`;
            
            // 记录轮询日志（但不打印到界面）
            logData.push(`轮询 ${i+1}/120：${JSON.stringify(data, null, 2)}`);

            if (data.task_status === 'SUCCEED') {
                const urls = data.output_images;
                statusEl.innerHTML = '<span class="success">生成成功：' + prompt + '</span>';
                
                // 记录最终结果
                logData.push('\n--- 最终结果 ---');
                logData.push(JSON.stringify(data, null, 2));
                logData.push('');
                
                urls.forEach((url, index) => {
                    // 生成文件名，包含批次序号
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const safePrompt = prompt.substring(0, 20).replace(/[^\w\s]/gi, '').trim();
                    const filename = `${safePrompt}_batch${batchIndex}_${timestamp}.png`;
                    
                    // 添加到全局数组
                    allGeneratedImages.push({ url, filename, prompt });
                    
                    // 创建图片元素
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    
                    const img = document.createElement('img');
                    img.src = url;
                    img.title = prompt;
                    img.onclick = function() { openModal(url); };
                    
                    const p = document.createElement('p');
                    p.textContent = prompt.length > 20 ? prompt.substring(0, 20) + '...' : prompt;
                    
                    // 添加下载指示器
                    const downloadIndicator = document.createElement('div');
                    downloadIndicator.className = 'download-indicator';
                    downloadIndicator.textContent = '已下载';
                    
                    imageItem.appendChild(img);
                    imageItem.appendChild(p);
                    imageItem.appendChild(downloadIndicator);
                    resultEl.appendChild(imageItem);
                    
                    // 自动下载图片
                    downloadImage(url, filename);
                });
                return true; // 返回成功状态
            } else if (data.task_status === 'FAILED') {
                statusEl.innerHTML = '<span class="error">生成失败：' + prompt + ' - ' + JSON.stringify(data) + '</span>';
                
                // 记录失败结果
                logData.push('\n--- 最终结果 ---');
                logData.push(JSON.stringify(data, null, 2));
                logData.push('');
                
                return false; // 返回失败状态
            }
        }
        statusEl.innerHTML = '<span class="error">任务超时：' + prompt + '</span>';
        return false; // 返回超时状态
    }

    // 下载单个图片
    function downloadImage(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // 下载所有图片
    function downloadAllImages() {
        if (allGeneratedImages.length === 0) {
            alert('没有可下载的图片');
            return;
        }
        
        allGeneratedImages.forEach((image, index) => {
            // 添加延迟，避免浏览器阻止多个下载
            setTimeout(() => {
                downloadImage(image.url, image.filename);
            }, index * 500); // 每500ms下载一个
        });
    }

    // 复制日志到剪贴板
    function copyLog() {
        const logContent = document.getElementById('logContent').textContent;
        navigator.clipboard.writeText(logContent).then(() => {
            alert('日志已复制到剪贴板！');
        }).catch(err => {
            console.error('复制失败：', err);
            alert('复制失败，请手动选择文本复制');
        });
    }

    function openModal(src) {
        document.getElementById('imageModal').style.display = 'block';
        document.getElementById('modalImage').src = src;
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // 点击模态框外部关闭
    window.onload = function() {
        // 页面加载时检查是否有历史日志
        const logHistory = JSON.parse(localStorage.getItem('modelscope_log_history') || '[]');
        if (logHistory.length > 0) {
            console.log('历史日志记录：', logHistory);
            console.log('查看日志方法：在控制台输入 localStorage.getItem("modelscope_log_2025-01-01T00-00-00-000Z")');
        }
    };
    
    window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    </script>
</body>
</html>
